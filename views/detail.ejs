<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Page</title>
    <link href="/main.css" rel = "stylesheet">
</head>
<body class="grey-bg">

  <div class>
    <h4> </h4>
  </div>

    <%- include('nav.ejs') %>
    <!-- <%= JSON.stringify(result) %> -->
    
    <div class>
      <h4> </h4>
    </div>

    <div class="navbar navbar-light" style="background-color: #e3f2fd;", left:50% >
      <span class="align-middle"><%= result.date %> 의 todo를 확인해주세요</span>
    </div>

    <div class>
      <h4> </h4>
    </div>

    <% for (let i = 0 ; i < result.content.length; i++){ %>

    <div class="white-bg">
        <div class="list-box">
            <h5><%= result.content[i] %>
            <span class="delete" data-content="<%= encodeURIComponent(result.content[i]) %>" data-id="<%= result._id %>">🗑️</span>
            </h5>
        </div>
    </div>

    <div class="white-bg">
      <input type="text" id="edit-content-<%= i %>" placeholder="수정사항 입력">
      <button class="edit" data-index="<%= i %>" data-id="<%= result._id %>" id="edit-button-<%= i %>">✏️</button>
    </div>
  <% } %>

  <div>
    <input type="text" id="new-content" placeholder="새 할일 입력">
    <button class="add-button">추가</button>
    <p id="error-message" style="color: red;"></p>
  </div>
    
<script>
  document.querySelectorAll('.delete').forEach(element =>{
    element.addEventListener('click', function(e){
    // e.target.dataset.id
    const doccontent = encodeURIComponent(e.target.dataset.content)
    const id = encodeURIComponent(e.target.dataset.id)

    fetch(`/delete?doccontent=${doccontent}&id=${id}`,{
      method : 'DELETE'
    })
    .then(response => response.text())
    .then(result=> {
      location.reload()
      console.log(result)
    })
    .catch(error => console.error(error))
  }) 
})
</script>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.edit').forEach(element => {
      element.addEventListener('click', function(e) {
        console.log('버튼 클릭됨');

        const index = e.target.dataset.index
        const newContent = document.getElementById(`edit-content-${index}`).value;
        
        console.log('보낼 데이터:', { id: e.target.dataset.id, index: index, content: newContent });

        fetch('/edit', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: e.target.dataset.id,
            index: index,
            content: encodeURIComponent(newContent)
          })
        })
        .then((response) => response.text())
        .then((data) => {
          location.reload()
          console.log('응답 데이터:', data);
        })
        .catch(error => {
          console.log('에러:', error);
        });
      });
    });
  });
</script>

<script>
document.querySelector('.add-button').addEventListener('click', function() {
  const newcontent = document.getElementById('new-content').value;
  const id = '<%= result._id %>';
  const errorMessage = document.getElementById('error-message');

  if (newcontent.trim() === '') {
      errorMessage.textContent = '내용을 입력해주세요.';
      return;
  }

  fetch('/add', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ newcontent: newcontent, id: id })
  })
  .then(response => response.json())
  .then(result => {
    console.log(result);
    location.reload(); // 추가 후 페이지 새로고침
  })
  .catch(error => console.error(error));
});
</script>

</body>
</html>